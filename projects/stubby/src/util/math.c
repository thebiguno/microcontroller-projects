#include "math.h"

//In this library, we pass in / pass out angles in radians.  Internally, we use a custom measurement which maps
// 90 degrees (PI / 2 radians) into 256 segments (hereafter this unit is called a 'segment', or 'seg').

//Generated with: 
//    for (double i = -1; i <= 1; i+=0.01){ printf("%1.5f, ", acos(i)); }
// (add a 0 at the end)
static double lookup_acos[201] = {
	3.14159, 3.00005, 2.94126, 2.89603, 2.85780, 2.82403, 2.79343, 2.76521, 2.73888, 2.71408, 2.69057, 2.66814, 2.64666, 2.62600, 2.60607, 2.58678, 2.56808, 2.54990, 2.53221, 2.51495, 2.49809, 2.48161, 2.46546, 2.44964, 2.43411, 2.41886, 2.40387, 2.38912, 2.37460, 2.36029, 2.34619, 2.33229, 2.31856, 2.30501, 2.29162, 2.27838, 2.26529, 2.25235, 2.23954, 2.22686, 2.21430, 2.20186, 2.18953, 2.17730, 2.16518, 2.15316, 2.14123, 2.12940, 2.11765, 2.10598, 2.09440, 2.08289, 2.07145, 2.06009, 2.04879, 2.03756, 2.02640, 2.01529, 2.00424, 1.99325, 1.98231, 1.97143, 1.96059, 1.94981, 1.93906, 1.92837, 1.91771, 1.90710, 1.89653, 1.88599, 1.87549, 1.86502, 1.85459, 1.84419, 1.83382, 1.82348, 1.81316, 1.80287, 1.79261, 1.78237, 1.77215, 1.76196, 1.75178, 1.74163, 1.73149, 1.72136, 1.71126, 1.70117, 1.69109, 1.68102, 1.67096, 1.66092, 1.65088, 1.64085, 1.63083, 1.62082, 1.61081, 1.60080, 1.59080, 1.58080, 1.57080, 1.56080, 1.55079, 1.54079, 1.53079, 1.52078, 1.51076, 1.50074, 1.49071, 1.48067, 1.47063, 1.46057, 1.45051, 1.44043, 1.43033, 1.42023, 1.41011, 1.39997, 1.38981, 1.37963, 1.36944, 1.35922, 1.34898, 1.33872, 1.32843, 1.31812, 1.30777, 1.29740, 1.28700, 1.27657, 1.26610, 1.25560, 1.24507, 1.23449, 1.22388, 1.21323, 1.20253, 1.19179, 1.18100, 1.17016, 1.15928, 1.14834, 1.13735, 1.12630, 1.11520, 1.10403, 1.09280, 1.08151, 1.07014, 1.05871, 1.04720, 1.03561, 1.02395, 1.01220, 1.00036, 0.98843, 0.97641, 0.96429, 0.95207, 0.93974, 0.92730, 0.91474, 0.90205, 0.88924, 0.87630, 0.86321, 0.84998, 0.83659, 0.82303, 0.80931, 0.79540, 0.78130, 0.76699, 0.75247, 0.73773, 0.72273, 0.70748, 0.69196, 0.67613, 0.65999, 0.64350, 0.62664, 0.60939, 0.59169, 0.57351, 0.55481, 0.53553, 0.51559, 0.49493, 0.47345, 0.45103, 0.42751, 0.40272, 0.37638, 0.34817, 0.31756, 0.28379, 0.24557, 0.20033, 0.14154, 0.00000
};

//Generated with:
//    for (uint16_t i = 0; i <= 255; i++){ printf("%1.5f, ", cos(i * M_PI / 512)); }
// (add a 0 at the end)
static double lookup_cos[257] = {
	1.00000, 0.99998, 0.99992, 0.99983, 0.99970, 0.99953, 0.99932, 0.99908, 0.99880, 0.99848, 0.99812, 0.99772, 0.99729, 0.99682, 0.99631, 0.99577, 0.99518, 0.99456, 0.99391, 0.99321, 0.99248, 0.99171, 0.99090, 0.99006, 0.98918, 0.98826, 0.98730, 0.98631, 0.98528, 0.98421, 0.98311, 0.98196, 0.98079, 0.97957, 0.97832, 0.97703, 0.97570, 0.97434, 0.97294, 0.97150, 0.97003, 0.96852, 0.96698, 0.96539, 0.96378, 0.96212, 0.96043, 0.95870, 0.95694, 0.95514, 0.95331, 0.95144, 0.94953, 0.94759, 0.94561, 0.94359, 0.94154, 0.93946, 0.93734, 0.93518, 0.93299, 0.93077, 0.92851, 0.92621, 0.92388, 0.92151, 0.91911, 0.91668, 0.91421, 0.91171, 0.90917, 0.90660, 0.90399, 0.90135, 0.89867, 0.89597, 0.89322, 0.89045, 0.88764, 0.88480, 0.88192, 0.87901, 0.87607, 0.87309, 0.87009, 0.86705, 0.86397, 0.86087, 0.85773, 0.85456, 0.85136, 0.84812, 0.84485, 0.84155, 0.83822, 0.83486, 0.83147, 0.82805, 0.82459, 0.82110, 0.81758, 0.81404, 0.81046, 0.80685, 0.80321, 0.79954, 0.79584, 0.79211, 0.78835, 0.78456, 0.78074, 0.77689, 0.77301, 0.76910, 0.76517, 0.76120, 0.75721, 0.75319, 0.74914, 0.74506, 0.74095, 0.73682, 0.73265, 0.72846, 0.72425, 0.72000, 0.71573, 0.71143, 0.70711, 0.70275, 0.69838, 0.69397, 0.68954, 0.68508, 0.68060, 0.67609, 0.67156, 0.66700, 0.66242, 0.65781, 0.65317, 0.64851, 0.64383, 0.63912, 0.63439, 0.62964, 0.62486, 0.62006, 0.61523, 0.61038, 0.60551, 0.60062, 0.59570, 0.59076, 0.58580, 0.58081, 0.57581, 0.57078, 0.56573, 0.56066, 0.55557, 0.55046, 0.54532, 0.54017, 0.53500, 0.52980, 0.52459, 0.51936, 0.51410, 0.50883, 0.50354, 0.49823, 0.49290, 0.48755, 0.48218, 0.47680, 0.47140, 0.46598, 0.46054, 0.45508, 0.44961, 0.44412, 0.43862, 0.43309, 0.42756, 0.42200, 0.41643, 0.41084, 0.40524, 0.39962, 0.39399, 0.38835, 0.38268, 0.37701, 0.37132, 0.36561, 0.35990, 0.35416, 0.34842, 0.34266, 0.33689, 0.33111, 0.32531, 0.31950, 0.31368, 0.30785, 0.30201, 0.29615, 0.29028, 0.28441, 0.27852, 0.27262, 0.26671, 0.26079, 0.25487, 0.24893, 0.24298, 0.23702, 0.23106, 0.22508, 0.21910, 0.21311, 0.20711, 0.20110, 0.19509, 0.18907, 0.18304, 0.17700, 0.17096, 0.16491, 0.15886, 0.15280, 0.14673, 0.14066, 0.13458, 0.12850, 0.12241, 0.11632, 0.11022, 0.10412, 0.09802, 0.09191, 0.08580, 0.07968, 0.07356, 0.06744, 0.06132, 0.05520, 0.04907, 0.04294, 0.03681, 0.03067, 0.02454, 0.01841, 0.01227, 0.00614, 0.00000
};

//Generated with:
//    for (uint16_t i = 0; i <= 255; i++){ printf("%1.5f, ", sin(i * M_PI / 512)); }
// (add a 1 at the end)
static double lookup_sin[257] = {
	0.00000, 0.00614, 0.01227, 0.01841, 0.02454, 0.03067, 0.03681, 0.04294, 0.04907, 0.05520, 0.06132, 0.06744, 0.07356, 0.07968, 0.08580, 0.09191, 0.09802, 0.10412, 0.11022, 0.11632, 0.12241, 0.12850, 0.13458, 0.14066, 0.14673, 0.15280, 0.15886, 0.16491, 0.17096, 0.17700, 0.18304, 0.18907, 0.19509, 0.20110, 0.20711, 0.21311, 0.21910, 0.22508, 0.23106, 0.23702, 0.24298, 0.24893, 0.25487, 0.26079, 0.26671, 0.27262, 0.27852, 0.28441, 0.29028, 0.29615, 0.30201, 0.30785, 0.31368, 0.31950, 0.32531, 0.33111, 0.33689, 0.34266, 0.34842, 0.35416, 0.35990, 0.36561, 0.37132, 0.37701, 0.38268, 0.38835, 0.39399, 0.39962, 0.40524, 0.41084, 0.41643, 0.42200, 0.42756, 0.43309, 0.43862, 0.44412, 0.44961, 0.45508, 0.46054, 0.46598, 0.47140, 0.47680, 0.48218, 0.48755, 0.49290, 0.49823, 0.50354, 0.50883, 0.51410, 0.51936, 0.52459, 0.52980, 0.53500, 0.54017, 0.54532, 0.55046, 0.55557, 0.56066, 0.56573, 0.57078, 0.57581, 0.58081, 0.58580, 0.59076, 0.59570, 0.60062, 0.60551, 0.61038, 0.61523, 0.62006, 0.62486, 0.62964, 0.63439, 0.63912, 0.64383, 0.64851, 0.65317, 0.65781, 0.66242, 0.66700, 0.67156, 0.67609, 0.68060, 0.68508, 0.68954, 0.69397, 0.69838, 0.70275, 0.70711, 0.71143, 0.71573, 0.72000, 0.72425, 0.72846, 0.73265, 0.73682, 0.74095, 0.74506, 0.74914, 0.75319, 0.75721, 0.76120, 0.76517, 0.76910, 0.77301, 0.77689, 0.78074, 0.78456, 0.78835, 0.79211, 0.79584, 0.79954, 0.80321, 0.80685, 0.81046, 0.81404, 0.81758, 0.82110, 0.82459, 0.82805, 0.83147, 0.83486, 0.83822, 0.84155, 0.84485, 0.84812, 0.85136, 0.85456, 0.85773, 0.86087, 0.86397, 0.86705, 0.87009, 0.87309, 0.87607, 0.87901, 0.88192, 0.88480, 0.88764, 0.89045, 0.89322, 0.89597, 0.89867, 0.90135, 0.90399, 0.90660, 0.90917, 0.91171, 0.91421, 0.91668, 0.91911, 0.92151, 0.92388, 0.92621, 0.92851, 0.93077, 0.93299, 0.93518, 0.93734, 0.93946, 0.94154, 0.94359, 0.94561, 0.94759, 0.94953, 0.95144, 0.95331, 0.95514, 0.95694, 0.95870, 0.96043, 0.96212, 0.96378, 0.96539, 0.96698, 0.96852, 0.97003, 0.97150, 0.97294, 0.97434, 0.97570, 0.97703, 0.97832, 0.97957, 0.98079, 0.98196, 0.98311, 0.98421, 0.98528, 0.98631, 0.98730, 0.98826, 0.98918, 0.99006, 0.99090, 0.99171, 0.99248, 0.99321, 0.99391, 0.99456, 0.99518, 0.99577, 0.99631, 0.99682, 0.99729, 0.99772, 0.99812, 0.99848, 0.99880, 0.99908, 0.99932, 0.99953, 0.99970, 0.99983, 0.99992, 0.99998, 1.00000
};

uint8_t constrain_angle(int16_t angle, uint8_t *quadrant){
	//Get the angle into 0..1024 segments (0..360 degrees)
	while (angle < 0){
		angle += 1024;
	}
	while (angle >= 1024){
		angle -= 1024;
	}
	
	if (angle <= 255) {
		*quadrant = 1;
	}
	else if (angle <= 512){
		*quadrant = 2;
		angle = 512 - angle;
	}
	else if (angle <= 768){
		*quadrant = 3;
		angle = angle - 512;
	}
	else {
		*quadrant = 4;
		angle = 1024 - angle;
	}

	return angle;
}

double acos_f(double value){
	if (value < -1 || value > 1) return NAN;
	return lookup_acos[(uint8_t) ((value * 100) + 100)];
}

double cos_f(double angle_r){
	int16_t angle = angle_r * 512 / M_PI;
	uint8_t quadrant = 0;
	angle = constrain_angle(angle, &quadrant);
	return lookup_cos[angle] * (quadrant == 2 || quadrant == 3 ? -1 : 1);
}

double sin_f(double angle_r){
	int16_t angle = angle_r * 512 / M_PI;
	uint8_t quadrant = 0;
	angle = constrain_angle(angle, &quadrant);
	return lookup_sin[angle] * (quadrant >= 3 ? -1 : 1);
}

uint16_t sqrt_f(uint16_t q){
	uint8_t r;
	uint8_t mask;
	uint8_t i = 8 * sizeof(r) - 1;

	r = mask = 1 << i;

	for (; i > 0; i--){
		mask >>=  1;

		if (q < ( uint16_t ) r * r ) r -= mask;
		else r += mask;
	}

	if (q < (uint16_t) r * r ) r -= 1;

	return r ; 
}
